<%
  # The xml is obtained as a string from builder template.
  str_xml = render :file => "drilldown/data_#{@dimensions.size}"
  str_xml = str_xml.gsub("\n", "").gsub("\r", "").gsub("&amp;", "&").gsub("'", "").html_safe

  type = nil
  case @search.display_type
  when SimpleDrilldown::Search::DisplayType::PIE
    type = 'Pie3D'
  when SimpleDrilldown::Search::DisplayType::BAR
    type = (@search.dimensions && @search.dimensions.size >= 2) ? 'MSCombi3D' : 'Column2D'
  when SimpleDrilldown::Search::DisplayType::LINE
    type = (@search.dimensions && @search.dimensions.size >= 2) ? 'MSLine' : 'Line'
  end
  if type %>
  <div id="chartdiv" align="center">Chart will load here</div>
  <script type="text/javascript">
    var chart = new FusionCharts("<%= asset_path(type + '.swf') %>", "ChartId_Election", "650", "400", "0", "1");
    chart.setXMLData('<%= str_xml %>');
    chart.render("chartdiv");
  </script>
<% else %>
  <div id="drilldown_area">
    <h2><%= caption %></h2>
    <h3><%= subcaption %></h3>
    <br/>
  </div>
<% end %>
<div id="drilldown_search_area" style="margin-left: auto; margin-right: auto; text-align: center">
  <% (0..2).each do |i| %>
    <%
      options = [['', '']]
      options << [@dimensions[i][:pretty_name], @dimensions[i][:url_param_name]] if @dimensions[i]
      options += @remaining_dimensions.keys.map { |name| [@dimension_defs[name][:pretty_name], name] }
    %>
    <%= t(i == 0 ? :group_by : :then_by) %>:
    <%= form.select 'dimensions', options, { :selected => @search.dimensions && @search.dimensions[i] },
        { :onChange => 'form.submit()', :name => 'search[dimensions][]', :id => "search_dimensions_#{i}" }
    %>
  <% end %>
  <br/>
  <%= t :chart_type %>:
  <%= form.radio_button 'display_type', SimpleDrilldown::Search::DisplayType::BAR, { :onChange => 'form.submit()' } %>
  <%= form.label :display_type_bar, t(:bar) %>
  <%= form.radio_button 'display_type', SimpleDrilldown::Search::DisplayType::PIE, { :disabled => @search.dimensions.size >= 2, :onChange => 'form.submit()' } %>
  <%= form.label :display_type_pie, t(:pie) %>
  <%= form.radio_button 'display_type', SimpleDrilldown::Search::DisplayType::LINE, { :onChange => 'form.submit()' } %>
  <%= form.label :display_type_line, t(:line) %>
  <%= form.radio_button 'display_type', SimpleDrilldown::Search::DisplayType::NONE, { :onChange => 'form.submit()' } %>
  <%= form.label :display_type_none, t(:none) %>

  <%= form.check_box :order_by_value, { :onChange => 'form.submit()' } %>
  <%= form.label :order_by_value, t(:order_by_value) %>

  <%= form.check_box :list, { :onChange => 'form.submit()' } %>
  <%= form.label :list, t(:list) %>
</div>
